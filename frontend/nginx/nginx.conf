server {
  listen 80;
  server_name _;

  # --- gzip
  gzip on;
  gzip_min_length 256;
  gzip_types text/plain text/css text/javascript application/javascript application/json application/xml application/xml+rss image/svg+xml;
  gzip_vary on; 

  # --- корень статики (Vite build)
  root  /usr/share/nginx/html;
  index index.html;

  # --- Docker DNS
  # Иначе при смене IP у контейнера может потребоваться рестарт NGINX
  resolver 127.0.0.11 ipv6=off valid=10s;   # встроенный DNS Docker
  resolver_timeout 5s;

  set $backend http://backend:3000;
  set $scalar  http://scalar:8080;

  # ===== Проксирование API и Scalar =====
  location ^~ /api/ {
    proxy_pass         $backend;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_read_timeout 120s;
  }

  location = /openapi.json { proxy_pass $backend; }

  # Подключаем Scalar под /docs/ (со слэшем, чтобы срезать префикс). Правило proxy_pass. :contentReference[oaicite:5]{index=5}
  location ^~ /docs/ {
    rewrite ^/docs/(.*)$ /$1 break;
    proxy_pass         $scalar;       # ВАЖНО: без завершающего '/'
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_read_timeout 120s;
  }

  # ===== Кэширование статики (просто и наглядно) =====
  # Для SPA обычно: index.html без кэша, ассеты с длинным max-age. :contentReference[oaicite:6]{index=6}
  location = /index.html {
    expires -1;                        # no-cache для HTML (официальное поведение expires < 0) :contentReference[oaicite:7]{index=7}
  }

  location ~* \.(?:js|css|svg|ico|png|jpg|jpeg|gif|webp|avif|woff2?)$ {
    expires 1y;                        # выставит Expires и Cache-Control: max-age=…  :contentReference[oaicite:8]{index=8}
    add_header Vary "Accept-Encoding";
    try_files $uri =404;
  }

  # ===== SPA fallback =====
  # Все неизвестные пути — на index.html (клиентский роутинг). :contentReference[oaicite:9]{index=9}
  location / {
    try_files $uri $uri/ /index.html;
  }
}